<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Completo - Personagens, Livros e Atores</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>Painel de Controle</h1>

  <div class="menu-container">
    <div class="menu-item" onclick="carregarPersonagens()">üìÇ Listar Personagens</div> 
    <div class="menu-item cadastrar" onclick="montarFormPersonagem()">‚ûï Cadastrar Personagem</div>
    
    <div class="menu-item" onclick="carregarLivros()">üìÇ Listar Livros</div>
    <div class="menu-item cadastrar" onclick="montarFormLivro()">‚ûï Cadastrar Livro</div>

    <div class="menu-item" onclick="carregarAtores()">üìÇ Listar Atores</div>
    <div class="menu-item cadastrar" onclick="montarFormAtor()">‚ûï Cadastrar Ator</div>
  </div>

  <div id="resultado"></div>

<script>
    // ==========================================
    // 1. LISTAGEM DE PERSONAGENS
    // ==========================================
    async function carregarPersonagens() {
      const divResultado = document.getElementById('resultado');
      divResultado.className = 'grid-view'; // Ativa o grid CSS
      divResultado.innerHTML = "<p class='loading'>Carregando Personagens...</p>";

      try {
        // ATEN√á√ÉO: ?acao=listar_personagens √© obrigat√≥rio
        const response = await fetch('menu_sql.php?acao=listar_personagens'); 
        
        if (!response.ok) throw new Error("Erro HTTP: " + response.status);

        const json = await response.json();
        
        if(json.status === 'erro') throw new Error(json.mensagem);

        // Limpa e Renderiza
        divResultado.innerHTML = "";
        json.dados.forEach(p => {
            divResultado.innerHTML += `
              <div class="card" style="cursor:pointer;" onclick='editarPersonagem(${JSON.stringify(p)})'>
                <h3>${p.nome}</h3>
                <p class="info"><strong>Local:</strong> ${p.local}</p>
                <p class="info"><strong>Idade:</strong> ${p.idade}</p>
                <p class="info"><strong>Altura:</strong> ${p.altura}</p>
              </div>
            `;
        });

      } catch (error) {
        divResultado.className = ''; // Remove grid para mostrar erro
        divResultado.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
      }
    }

    // ==========================================
    // 2. LISTAGEM DE LIVROS
    // ==========================================
    async function carregarLivros() {
      const divResultado = document.getElementById('resultado');
      divResultado.className = 'grid-view';
      divResultado.innerHTML = "<p class='loading'>Carregando Livros...</p>";

      try {
        const response = await fetch('menu_sql.php?acao=listar_livros'); 
        const json = await response.json();
        
        if(json.status === 'erro') throw new Error(json.mensagem);

        divResultado.innerHTML = "";
        json.dados.forEach(livro => {
            divResultado.innerHTML += `
              <div class="card" style="border-left-color: #6f42c1; cursor:pointer;" onclick='editarLivro(${JSON.stringify(livro)})'>
                <h3>${livro.nome}</h3>
                <p class="info"><strong>Autor:</strong> ${livro.autor}</p>
                <p class="info"><strong>G√™nero:</strong> ${livro.genero}</p>
                <p class="info"><em>${livro.descricao}</em></p>
              </div>
            `;
        });

      } catch (error) {
        divResultado.className = '';
        divResultado.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
      }
    }

    // ==========================================
    // 3. LISTAGEM DE ATORES
    // ==========================================
    async function carregarAtores() {
      const divResultado = document.getElementById('resultado');
      divResultado.className = 'grid-view';
      divResultado.innerHTML = "<p class='loading'>Carregando Atores...</p>";

      try {
        const response = await fetch('menu_sql.php?acao=listar_atores'); 
        const json = await response.json();

        if(json.status === 'erro') throw new Error(json.mensagem);

        divResultado.innerHTML = "";
        json.dados.forEach(ator => {
            divResultado.innerHTML += `
              <div class="card" 
              style="border-left-color: #ffc107; cursor: pointer;" 
              onclick='editarAtor(${JSON.stringify(ator)})'>
                <h3>${ator.nome}</h3>
                <p class="info"><strong>Oscars:</strong> ${ator.num_oscars} üèÜ</p>
                <p class="info"><strong>Idade:</strong> ${ator.idade} anos</p>
              </div>
            `;
        });

      } catch (error) {
        divResultado.className = '';
        divResultado.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
      }
    }

    // ==========================================
    // 4. CADASTRO DE PERSONAGEM
    // ==========================================
    function montarFormPersonagem() {
      const divResultado = document.getElementById('resultado');
      divResultado.className = '';
      
      divResultado.innerHTML = `
        <h2>Novo Personagem</h2>
        <form id="formPersonagem" onsubmit="salvarPersonagem(event)">
          <label>Nome:</label>
          <input type="text" id="nome" required placeholder="Nome do personagem">
          
          <label>Local:</label>
          <input type="text" id="local" required placeholder="Onde vive?">
          
          <label>Idade:</label>
          <input type="number" id="idade" required>
          
          <label>Altura:</label>
          <input type="text" id="altura" placeholder="Ex: 1.75">
          
          <button type="submit">Salvar Personagem</button>
        </form>
        <div id="mensagem"></div>
      `;
    }

    async function salvarPersonagem(event) {
      event.preventDefault();

      const nome = document.getElementById('nome').value.trim();
      const local = document.getElementById('local').value.trim();
      const idade = document.getElementById('idade').value.trim();
      let altura = document.getElementById('altura').value.trim();
      const divMsg = document.getElementById('mensagem');

      altura = altura.replace(',', '.');

      divMsg.innerHTML = "<p class='loading'>Salvando...</p>";

      try {
        const response = await fetch('gravar_personagem_pdo.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, local, idade, altura })
        });
        const result = await response.json();

        if (result.sucesso) {
          divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
          document.getElementById('formPersonagem').reset(); // ID corrigido
        } else {
          divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
        }
      } catch (error) {
        divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
      }
    }

    // ==========================================
    // 5. CADASTRO DE LIVRO
    // ==========================================
    function montarFormLivro() {
      const divResultado = document.getElementById('resultado');
      divResultado.className = ''; 

      divResultado.innerHTML = `
        <h2>Novo Livro</h2>
        <form id="formLivro" onsubmit="salvarLivro(event)">
          <label>Nome do Livro:</label>
          <input type="text" id="nome_livro" required>

          <label>Descri√ß√£o:</label>
          <input type="text" id="desc_livro">

          <label>Autor:</label>
          <input type="text" id="autor_livro">

          <label>G√™nero:</label>
          <input type="text" id="genero_livro" required>

          <button type="submit" style="background-color: #6f42c1">Salvar Livro</button>
        </form>
        <div id="mensagem_livro"></div>
      `;
    }

    async function salvarLivro(event) {
      event.preventDefault();
      
      const nome = document.getElementById('nome_livro').value.trim();
      const descricao = document.getElementById('desc_livro').value.trim();
      const autor = document.getElementById('autor_livro').value.trim();
      const genero = document.getElementById('genero_livro').value.trim();
      const divMsg = document.getElementById('mensagem_livro');

      divMsg.innerHTML = "<p class='loading'>Salvando...</p>";

      try {
        const response = await fetch('gravar_livro_pdo.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, descricao, autor, genero })
        });

        const result = await response.json();

        if (result.sucesso) {
          divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
          document.getElementById('formLivro').reset();
        } else {
          divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
        }
      } catch (error) {
        divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
      }
    }

    // ==========================================
    // 6. CADASTRO DE ATOR
    // ==========================================
    function montarFormAtor() {
      const divResultado = document.getElementById('resultado');
      divResultado.className = '';

      divResultado.innerHTML = `
        <h2>Novo Ator/Atriz</h2>
        <form id="formAtor" onsubmit="salvarAtor(event)">
          <label>Nome:</label>
          <input type="text" id="nome_ator" required>

          <label>N√∫mero de Oscars:</label>
          <input type="number" id="oscars_ator" value="0">

          <label>Idade:</label>
          <input type="number" id="idade_ator" required>

          <button type="submit" style="background-color: #ffc107; color: #000;">Salvar Ator</button>
        </form>
        <div id="mensagem_ator"></div>
      `;
    }

    async function salvarAtor(event) {
      event.preventDefault();

      const nome = document.getElementById('nome_ator').value.trim();
      const num_oscars = document.getElementById('oscars_ator').value.trim();
      const idade = document.getElementById('idade_ator').value.trim();
      const divMsg = document.getElementById('mensagem_ator');

      divMsg.innerHTML = "<p class='loading'>Salvando...</p>";

      try {
        const response = await fetch('gravar_ator_pdo.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, num_oscars, idade })
        });

        const result = await response.json();

        if (result.sucesso) {
          divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
          document.getElementById('formAtor').reset();
        } else {
          divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
        }
      } catch (error) {
        divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
      }
    }

    // ======================================================
    // 3. EDITAR PERSONAGEM
    // ======================================================
    function editarPersonagem(personagem) {
    const divResultado = document.getElementById('resultado');
    divResultado.className = '';

    // 1. TRATAMENTO DE IDADE (campo 'number' REQUIRED)
    // Se for null, usa string vazia.
    const idadeDisplay = (personagem.idade === null || String(personagem.idade).toLowerCase() === 'null') 
        ? '' 
        : personagem.idade;

    // 2. TRATAMENTO DE ALTURA (campo 'text' formatado)
    // Se for null, usa string vazia. Se for n√∫mero, troca '.' por ','
    const alturaDisplay = (personagem.altura === null || String(personagem.altura).toLowerCase() === 'null') 
        ? '' 
        : String(personagem.altura).replace('.', ',');


    divResultado.innerHTML = `
        <h2>Alterar Personagem ID: ${personagem.id_personagem}</h2>
        <form id="formAlterarPersonagem" onsubmit="salvarAlteracaoPersonagem(event)">
            <input type="hidden" id="id_personagem" value="${personagem.id_personagem}"> 

            <label>Nome:</label>
            <input type="text" id="nome_edit" required value="${personagem.nome}"><br><br>

            <label>Local:</label>
            <input type="text" id="local_edit" required value="${personagem.local}"><br><br>

            <label>Idade:</label>
            <input type="number" id="idade_edit" required value="${idadeDisplay}"><br><br>

            <label>Altura (v√≠rgula):</label>
            <input type="text" id="altura_edit" value="${alturaDisplay}" placeholder="0,00"><br><br>

            <button type="submit" style="background-color: orange;">Salvar Altera√ß√µes</button> ¬† ¬† ¬† ¬†
            <button type="button" 
              style="background-color: #dc3545; margin-top: 10px;" 
              onclick="removerPersonagem(${personagem.id_personagem}, '${personagem.nome}')">
              ‚ùå Remover Personagem
            </button>

        </form>
        <div id="mensagem_alteracao"></div>
    `;
}

    async function salvarAlteracaoPersonagem(event) {
        event.preventDefault(); 

        // 1. Coleta dados
        const id_personagem = document.getElementById('id_personagem').value;
        const nome = document.getElementById('nome_edit').value.trim();
        const local = document.getElementById('local_edit').value.trim();
        const idade = document.getElementById('idade_edit').value.trim();
        
        // 2. Trata a v√≠rgula para o formato SQL (ponto)
        let altura = document.getElementById('altura_edit').value.trim();
        altura = altura.replace(',', '.'); 
        
        const divMsg = document.getElementById('mensagem_alteracao');
        divMsg.innerHTML = "<p class='loading'>Enviando altera√ß√µes...</p>";

        try {
            const response = await fetch('alterar_personagem.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_personagem, nome, local, idade, altura })
            });

            const result = await response.json();

            if (result.sucesso) {
                divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
                // Opcional: Recarregar a lista para ver a altera√ß√£o
                setTimeout(carregarPersonagens, 1500); 
            } else {
                divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
            }
        } catch (error) {
            divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
        }
    }
    // ======================================================
    // 7. EDITAR LIVRO
    // ======================================================
    function editarLivro(livro) {
        const divResultado = document.getElementById('resultado');
        divResultado.className = ''; // Remove grid
        
        // ATEN√á√ÉO: Assumindo que o ID da tabela Livros se chama 'id_livro'
        divResultado.innerHTML = `
          <h2>Alterar Livro ID: ${livro.id_livro}</h2>
          <form id="formAlterarLivro" onsubmit="salvarAlteracaoLivro(event)">
            <input type="hidden" id="id_livro_edit" value="${livro.id_livro}"> 

            <label>Nome do Livro:</label>
            <input type="text" id="nome_livro_edit" required value="${livro.nome}"><br><br>

            <label>Descri√ß√£o:</label>
            <input type="text" id="desc_livro_edit" value="${livro.descricao}"><br><br>

            <label>Autor:</label>
            <input type="text" id="autor_livro_edit" value="${livro.autor}"><br><br>

            <label>G√™nero:</label>
            <input type="text" id="genero_livro_edit" required value="${livro.genero}"><br><br>

            <button type="submit" style="background-color: orange;">Salvar Altera√ß√µes do Livro</button>
         
            <button type="button" 
                style="background-color: #dc3545; margin-top: 10px;" 
                onclick="removerLivro(${livro.id_livro}, '${livro.nome}')">
                Remover Livro
            </button>
          </form>
          <div id="mensagem_alteracao_livro"></div>
        `;
    }

   
    async function salvarAlteracaoLivro(event) {
        event.preventDefault(); 

        // 1. Coleta dados (Note o sufixo _edit nos IDs)
        const id_livro = document.getElementById('id_livro_edit').value;
        const nome = document.getElementById('nome_livro_edit').value.trim();
        const descricao = document.getElementById('desc_livro_edit').value.trim();
        const autor = document.getElementById('autor_livro_edit').value.trim();
        const genero = document.getElementById('genero_livro_edit').value.trim();
        
        // Div de mensagem que criamos no formul√°rio
        const divMsg = document.getElementById('mensagem_alteracao_livro');
        divMsg.innerHTML = "<p class='loading'>Enviando altera√ß√µes...</p>";

        try {
            const response = await fetch('alterar_livro.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_livro, nome, descricao, autor, genero })
            });

            // Caso o PHP retorne um erro HTTP ou o JSON esteja malformado
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

            const result = await response.json();

            if (result.sucesso) {
                divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
                // Recarregar a lista de livros para ver o resultado ap√≥s 1.5s
                setTimeout(carregarLivros, 1500); 
            } else {
                divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
            }
        } catch (error) {
            divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
        }
    }

    // ======================================================
    // 9. EDITAR ATOR
    // ======================================================
    function editarAtor(ator) {
        const divResultado = document.getElementById('resultado');
        divResultado.className = ''; 

        divResultado.innerHTML = `
          <h2>Alterar Ator/Atriz ID: ${ator.id_ator}</h2>
          <form id="formAlterarAtor" onsubmit="salvarAlteracaoAtor(event)">
            <input type="hidden" id="id_ator_edit" value="${ator.id_ator}"> 

            <label>Nome:</label>
            <input type="text" id="nome_ator_edit" required value="${ator.nome}"><br><br>

            <label>N√∫mero de Oscars:</label>
            <input type="number" id="oscars_ator_edit" value="${ator.num_oscars}"><br><br>

            <label>Idade:</label>
            <input type="number" id="idade_ator_edit" required value="${ator.idade}"><br><br>

            <button type="submit" style="background-color: orange;">Salvar Altera√ß√µes do Ator</button>
            <button type="button" 
                style="background-color: #dc3545; margin-top: 10px;" 
                onclick="removerAtor(${ator.id_ator}, '${ator.nome}')">
                Remover Ator
            </button>
          </form>  
          <div id="mensagem_alteracao_ator"></div>
        `;
    }

    // ======================================================
    // 10. FUN√á√ÉO DE ENVIO DE ALTERA√á√ÉO - ENVIA DADOS AO PHP
    // ======================================================
    async function salvarAlteracaoAtor(event) {
        event.preventDefault(); 

        // 1. Coleta dados
        const id_ator = document.getElementById('id_ator_edit').value;
        const nome = document.getElementById('nome_ator_edit').value.trim();
        const num_oscars = document.getElementById('oscars_ator_edit').value.trim();
        const idade = document.getElementById('idade_ator_edit').value.trim();
        
        // Div de mensagem que criamos no formul√°rio
        const divMsg = document.getElementById('mensagem_alteracao_ator');
        divMsg.innerHTML = "<p class='loading'>Enviando altera√ß√µes...</p>";

        try {
            const response = await fetch('alterar_ator.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_ator, nome, num_oscars, idade })
            });

            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

            const result = await response.json();

            if (result.sucesso) {
                divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
                // Recarregar a lista para ver a altera√ß√£o
                setTimeout(carregarAtores, 1500); 
            } else {
                divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
            }
        } catch (error) {
            divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
        }
    }

    // ======================================================
// 5. FUN√á√ÉO DE REMO√á√ÉO DE PERSONAGEM
// ======================================================
async function removerPersonagem(id, nome) {
    // 1. Pede confirma√ß√£o
    if (!confirm(`Tem certeza que deseja remover o personagem: ${nome} (ID: ${id})? Essa a√ß√£o √© irrevers√≠vel.`)) {
        return;
    }
    
    // Div de mensagem que est√° no formul√°rio de edi√ß√£o
    const divMsg = document.getElementById('mensagem_alteracao'); 
    divMsg.innerHTML = "<p class='loading'>Removendo...</p>";

    try {
        const response = await fetch('deletar_personagem.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_personagem: id }) // Envia o ID para o PHP
        });

        const result = await response.json();

        if (result.sucesso) {
            divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
            // Recarregar a lista principal ap√≥s deletar
            setTimeout(carregarPersonagens, 1500); 
        } else {
            divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
        }
    } catch (error) {
        divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
    }
    }
    // ======================================================
    // 6. FUN√á√ÉO DE REMO√á√ÉO DE LIVRO
    // ======================================================
    async function removerLivro(id, nome) {
        // 1. Pede confirma√ß√£o
        if (!confirm(`Tem certeza que deseja remover o Livro: ${nome} (ID: ${id})? Essa a√ß√£o √© irrevers√≠vel.`)) {
            return;
        }
        
        // Usa a div de mensagem do formul√°rio de edi√ß√£o de livro
        const divMsg = document.getElementById('mensagem_alteracao_livro'); 
        divMsg.innerHTML = "<p class='loading'>Removendo...</p>";

        try {
            const response = await fetch('deletar_livro.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_livro: id }) // Envia o ID
            });

            const result = await response.json();

            if (result.sucesso) {
                divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
                // Recarregar a lista principal ap√≥s deletar
                setTimeout(carregarLivros, 1500); 
            } else {
                divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
            }
        } catch (error) {
            divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
        }
    }

    // ======================================================
    // 7. FUN√á√ÉO DE REMO√á√ÉO DE ATOR
    // ======================================================
    async function removerAtor(id, nome) {
        // 1. Pede confirma√ß√£o
        if (!confirm(`Tem certeza que deseja remover o Ator(a): ${nome} (ID: ${id})? Essa a√ß√£o √© irrevers√≠vel.`)) {
            return;
        }
        
        // Usa a div de mensagem do formul√°rio de edi√ß√£o de ator
        const divMsg = document.getElementById('mensagem_alteracao_ator'); 
        divMsg.innerHTML = "<p class='loading'>Removendo...</p>";

        try {
            const response = await fetch('deletar_ator.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_ator: id }) // Envia o ID
            });

            const result = await response.json();

            if (result.sucesso) {
                divMsg.innerHTML = `<p style="color:green;">‚úÖ ${result.mensagem}</p>`;
                // Recarregar a lista principal ap√≥s deletar
                setTimeout(carregarAtores, 1500); 
            } else {
                divMsg.innerHTML = `<p class="erro">‚ùå ${result.mensagem}</p>`;
            }
        } catch (error) {
            divMsg.innerHTML = `<p class="erro">Erro: ${error.message}</p>`;
        }
    }

</script>

</body>
</html>